{% extends 'base.html' %}
{% load static %}

{% block title %}{{ map_obj.name }} - Map Viewer - ADMA GEO{% endblock %}

{% block extra_css %}
<style>
    .map-container {
        height: 600px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
    }
    
    .map-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: rgba(255,255,255,0.9);
        border-radius: 8px;
        padding: 0.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .layer-legend {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        max-height: 400px;
        overflow-y: auto;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .legend-item:last-child {
        border-bottom: none;
    }
    
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        margin-right: 0.75rem;
        border: 1px solid #dee2e6;
    }
    
    .layer-info {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .basemap-selector {
        background: rgba(255,255,255,0.9);
        border-radius: 6px;
        margin-bottom: 0.5rem;
    }
    
    .map-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .ol-control {
        position: relative !important;
    }
    
    .ol-attribution {
        background: rgba(255,255,255,0.8) !important;
        border-radius: 4px !important;
        bottom: 8px !important;
        left: 8px !important;
        right: auto !important;
        max-width: calc(100% - 16px) !important;
        font-size: 11px !important;
        line-height: 1.2 !important;
        white-space: nowrap !important;
        padding: 2px 4px !important;
    }
    
    .ol-attribution ul {
        margin: 0 !important;
        padding: 0 !important;
        display: inline !important;
    }
    
    .ol-attribution li {
        display: inline !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .ol-attribution li:not(:last-child):after {
        content: ", ";
    }
    
    /* Attribution banner stretching full width at bottom of map */
    #map .ol-attribution {
        position: absolute !important;
        bottom: 0px !important;
        left: 0px !important;
        right: 0px !important;
        top: auto !important;
        width: 100% !important;
        transform: none !important;
        background: rgba(0, 0, 0, 0.8) !important;
        color: white !important;
        border-radius: 0 !important;
        padding: 8px 16px !important;
        font-size: 12px !important;
        max-width: none !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        box-shadow: 0 -2px 8px rgba(0,0,0,0.2) !important;
        z-index: 1000 !important;
        margin: 0 !important;
        text-align: center !important;
        border-top: 1px solid rgba(255,255,255,0.1) !important;
    }
    
    #map .ol-attribution ul {
        margin: 0 !important;
        padding: 0 !important;
    }
    
    #map .ol-attribution a {
        color: #87ceeb !important;
        text-decoration: none !important;
    }
    
    #map .ol-attribution a:hover {
        color: white !important;
        text-decoration: underline !important;
    }
    
    /* Zoom controls positioned at top-right - override OpenLayers defaults */
    #map .ol-zoom {
        position: absolute !important;
        top: 10px !important;
        right: 10px !important;
        left: auto !important;
        bottom: auto !important;
        background: rgba(255, 255, 255, 0.9) !important;
        border-radius: 6px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
        border: 1px solid rgba(0,0,0,0.1) !important;
        margin: 0 !important;
    }
    
    #map .ol-zoom button {
        background: transparent !important;
        border: none !important;
        color: #333 !important;
        font-size: 16px !important;
        font-weight: bold !important;
        width: 28px !important;
        height: 28px !important;
        margin: 2px !important;
        border-radius: 4px !important;
        transition: all 0.2s ease !important;
    }
    
    #map .ol-zoom button:hover {
        background: rgba(0,0,0,0.1) !important;
        color: #000 !important;
    }
    
    /* Scale line positioning - adjusted for full-width attribution banner */
    #map .ol-scale-line {
        position: absolute !important;
        bottom: 45px !important;
        left: 10px !important;
        right: auto !important;
        top: auto !important;
        background: rgba(255, 255, 255, 0.9) !important;
        border-radius: 4px !important;
        padding: 4px 8px !important;
        margin: 0 !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
        z-index: 1001 !important;
    }
    
    /* Full screen control */
    #map .ol-full-screen {
        position: absolute !important;
        top: 10px !important;
        right: 50px !important;
        left: auto !important;
        bottom: auto !important;
        background: rgba(255, 255, 255, 0.9) !important;
        border-radius: 6px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
        border: 1px solid rgba(0,0,0,0.1) !important;
        margin: 0 !important;
    }
    
    #map .ol-full-screen button {
        background: transparent !important;
        border: none !important;
        color: #333 !important;
        font-size: 14px !important;
        width: 28px !important;
        height: 28px !important;
        margin: 2px !important;
        border-radius: 4px !important;
        transition: all 0.2s ease !important;
    }
    
    #map .ol-full-screen button:hover {
        background: rgba(0,0,0,0.1) !important;
        color: #000 !important;
    }
</style>

<!-- OpenLayers CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Map Header -->
    <div class="map-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1">{{ map_obj.name }}</h2>
                {% if map_obj.description %}
                <p class="mb-0 opacity-75">{{ map_obj.description }}</p>
                {% endif %}
            </div>
            <div class="text-end">
                <span class="badge bg-light text-dark fs-6">{{ map_layers.count }} layers</span>
                <br>
                <small class="opacity-75">by {{ map_obj.owner.username }}</small>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Map Display -->
        <div class="col-lg-9">
            <!-- Map Controls (above map) -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <a href="{{ map_obj.get_absolute_url }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Map Details
                    </a>
                </div>
                
                <!-- Basemap Selector -->
                <div class="basemap-selector">
                    <select class="form-select form-select-sm" id="basemapSelector" onchange="changeBasemap()">
                        <option value="osm">OpenStreetMap</option>
                        <option value="satellite">Satellite</option>
                        <option value="terrain">Terrain</option>
                    </select>
                </div>
            </div>

            <!-- Map Container -->
            <div class="map-container">
                <div id="map" style="width: 100%; height: 100%;"></div>
            </div>
            
            <!-- Map Info -->
            <div class="layer-info mt-3">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Coordinate System:</strong> EPSG:3857 (Web Mercator)<br>
                        <strong>Total Layers:</strong> {{ map_layers.count }}
                    </div>
                    <div class="col-md-6">
                        <strong>Layer Group:</strong> {{ map_config.layer_group_name }}<br>
                        <strong>Last Updated:</strong> {{ map_obj.updated_at|date:"M d, Y" }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Layer Panel -->
        <div class="col-lg-3">
            <div class="layer-legend">
                <h5 class="mb-3">
                    <i class="fas fa-layers me-2"></i>Map Layers
                </h5>
                
                {% if map_layers %}
                {% for layer in map_layers %}
                <div class="legend-item">
                    <div class="legend-color" style="background: {% cycle '#e74c3c' '#3498db' '#2ecc71' '#f39c12' '#9b59b6' '#1abc9c' '#34495e' '#e67e22' %}"></div>
                    <div class="flex-grow-1">
                        <div class="fw-bold small">{{ layer.file.name }}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">
                            {{ layer.file.file_type|upper }}
                            {% if layer.file.owner != map_obj.owner %}
                            • by {{ layer.file.owner.username }}
                            {% endif %}
                        </div>
                        {% if not layer.is_visible %}
                        <div class="text-muted" style="font-size: 0.7rem;">
                            <i class="fas fa-eye-slash me-1"></i>Hidden
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-3">
                    <i class="fas fa-layer-group text-muted" style="font-size: 2rem;"></i>
                    <p class="text-muted mt-2 mb-0">No layers in this map</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Map Actions -->
            <div class="mt-3">
                <div class="d-grid gap-2">
                    {% if map_obj.owner == user %}
                    <a href="{{ map_obj.get_absolute_url }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-edit me-1"></i>Edit Map
                    </a>
                    {% endif %}
                    <button class="btn btn-outline-secondary btn-sm" onclick="zoomToExtent()">
                        <i class="fas fa-expand-arrows-alt me-1"></i>Zoom to Full Extent
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- OpenLayers JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>

<script>
let map;
let layerGroupLayer;
let baseLayer;

// Map configuration from Django
const mapConfig = {
    center_lat: {{ map_config.center_lat|default:"null" }},
    center_lng: {{ map_config.center_lng|default:"null" }},
    zoom_level: {{ map_config.zoom_level|default:"4" }},
    layer_group_name: "{{ map_config.layer_group_name }}",
    bbox_min_lat: {{ map_config.bbox_min_lat|default:"null" }},
    bbox_max_lat: {{ map_config.bbox_max_lat|default:"null" }},
    bbox_min_lng: {{ map_config.bbox_min_lng|default:"null" }},
    bbox_max_lng: {{ map_config.bbox_max_lng|default:"null" }}
};

// Initialize map when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Add a small delay to ensure OpenLayers is fully loaded
    setTimeout(function() {
        initializeMap();
    }, 100);
});

function initializeMap() {
    // Check if OpenLayers is available
    if (typeof ol === 'undefined') {
        console.error('OpenLayers library not loaded');
        document.getElementById('map').innerHTML = '<div class="alert alert-danger">Error: Map library failed to load</div>';
        return;
    }
    // Create base layer (OpenStreetMap)
    baseLayer = new ol.layer.Tile({
        source: new ol.source.OSM()
    });

    // Create Layer Group layer
    {% if map_layers %}
    layerGroupLayer = new ol.layer.Tile({
        source: new ol.source.TileWMS({
            url: '{{ settings.GEOSERVER_URL }}/wms',
            params: {
                'LAYERS': '{{ map_config.layer_group_name }}',
                'VERSION': '1.1.1',
                'FORMAT': 'image/png',
                'TRANSPARENT': true
            },
            serverType: 'geoserver'
        }),
        opacity: 1.0,
        visible: true
    });
    {% else %}
    layerGroupLayer = null;
    {% endif %}

    // Create map
    const layers = [baseLayer];
    if (layerGroupLayer) {
        layers.push(layerGroupLayer);
    }

    map = new ol.Map({
        target: 'map',
        layers: layers,
        controls: [], // Start with no default controls
        view: new ol.View({
            center: ol.proj.fromLonLat([mapConfig.center_lng, mapConfig.center_lat]),
            zoom: 6  // Always start at zoom level 6
        })
    });
    
    // Add controls manually for full control
    map.addControl(new ol.control.Zoom());
    map.addControl(new ol.control.Attribution({
        collapsible: false,
        className: 'ol-attribution ol-unselectable ol-control ol-collapsed'
    }));
    map.addControl(new ol.control.ScaleLine());
    map.addControl(new ol.control.FullScreen());
    
    // Smooth zoom to bounding box after a short delay
    if (mapConfig.bbox_min_lat !== null && mapConfig.bbox_max_lat !== null && 
        mapConfig.bbox_min_lng !== null && mapConfig.bbox_max_lng !== null) {
        
        // Wait a moment for the map to initialize, then animate to the data extent
        setTimeout(function() {
            // Transform bounding box to map projection
            const extent = ol.proj.transformExtent([
                mapConfig.bbox_min_lng, mapConfig.bbox_min_lat,
                mapConfig.bbox_max_lng, mapConfig.bbox_max_lat
            ], 'EPSG:4326', 'EPSG:3857');
            
            // Smooth zoom and pan to fit the data extent
            map.getView().fit(extent, {
                padding: [50, 50, 50, 50],
                duration: 2000,  // 2 second smooth animation
                maxZoom: 18
            });
            
            console.log('Zooming from 6 to optimal level for bounding box:', [
                mapConfig.bbox_min_lng, mapConfig.bbox_min_lat,
                mapConfig.bbox_max_lng, mapConfig.bbox_max_lat
            ]);
        }, 500);  // Wait 500ms for map to fully initialize
    }

    // Handle layer load events
    if (layerGroupLayer) {
        const source = layerGroupLayer.getSource();
        
        source.on('tileloadstart', function() {
            console.log('Layer Group tiles loading...');
        });
        
        source.on('tileloadend', function() {
            console.log('Layer Group tiles loaded');
        });
        
        source.on('tileloaderror', function(event) {
            console.error('Layer Group tile load error:', event);
        });
    }

    console.log('Map initialized successfully');
    console.log('Center:', mapConfig.center_lng, mapConfig.center_lat);
    console.log('Zoom:', mapConfig.zoom_level);
    {% if map_layers %}
    console.log('Layer Group:', '{{ map_config.layer_group_name }}');
    {% endif %}
}

function changeBasemap() {
    const selector = document.getElementById('basemapSelector');
    const selectedBasemap = selector.value;
    
    // Remove current base layer
    map.removeLayer(baseLayer);
    
    // Add new base layer
    switch(selectedBasemap) {
        case 'osm':
            baseLayer = new ol.layer.Tile({
                source: new ol.source.OSM()
            });
            break;
        case 'satellite':
            baseLayer = new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                    attributions: 'Tiles © Esri'
                })
            });
            break;
        case 'terrain':
            baseLayer = new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',
                    attributions: 'Tiles © Esri'
                })
            });
            break;
    }
    
    // Insert base layer at index 0 (bottom)
    map.getLayers().insertAt(0, baseLayer);
}

function zoomToExtent() {
    // Use the stored bounding box from the map configuration
    if (mapConfig.bbox_min_lat !== null && mapConfig.bbox_max_lat !== null && 
        mapConfig.bbox_min_lng !== null && mapConfig.bbox_max_lng !== null) {
        
        // Transform bounding box to map projection
        const extent = ol.proj.transformExtent([
            mapConfig.bbox_min_lng, mapConfig.bbox_min_lat,
            mapConfig.bbox_max_lng, mapConfig.bbox_max_lat
        ], 'EPSG:4326', 'EPSG:3857');
        
        // Fit the map to the extent with padding
        map.getView().fit(extent, {
            padding: [50, 50, 50, 50],
            duration: 1000,
            maxZoom: 18
        });
        
        console.log('Zoomed to stored extent:', [
            mapConfig.bbox_min_lng, mapConfig.bbox_min_lat,
            mapConfig.bbox_max_lng, mapConfig.bbox_max_lat
        ]);
    } else {
        // Fallback to center and zoom
        map.getView().animate({
            center: ol.proj.fromLonLat([mapConfig.center_lng, mapConfig.center_lat]),
            zoom: mapConfig.zoom_level,
            duration: 1000
        });
    }
}
</script>
{% endblock %}