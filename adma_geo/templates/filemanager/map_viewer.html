{% extends 'base.html' %}
{% load static %}

{% block title %}Map Viewer - {{ file.name }}{% endblock %}

{% block extra_head %}
<!-- OpenLayers CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">

<style>
    #map {
        height: 600px !important;
        width: 100% !important;
        border: 1px solid #ddd;
        min-height: 600px;
        position: relative;
    }
    
    /* Layer selector is now using Bootstrap form-select above the map */
    .map-info {
        background: #f8f9fa;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
    }
    
    /* Hide any attribution that might appear */
    .ol-attribution {
        display: none !important;
    }
    
    /* Make tables fit perfectly in information panels */
    .col-lg-3 {
        max-width: 100% !important;
        overflow-x: hidden !important;
    }
    
    .col-lg-3 .card {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
    }
    
    .col-lg-3 .card-body {
        padding: 1rem !important;
        overflow-x: hidden !important;
        width: 100% !important;
        box-sizing: border-box !important;
    }
    
    .col-lg-3 .table-responsive {
        overflow-x: auto !important;
        max-width: 100% !important;
    }
    
    .col-lg-3 .table {
        width: 100% !important;
        max-width: 100% !important;
        table-layout: fixed !important;
        margin-bottom: 0 !important;
        font-size: 0.85rem !important;
        border-collapse: collapse !important;
    }
    
    .col-lg-3 .table td {
        padding: 0.4rem 0.3rem !important;
        vertical-align: top !important;
        border: none !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        hyphens: auto !important;
        line-height: 1.3 !important;
    }
    
    .col-lg-3 .table td:first-child {
        width: 35% !important;
        font-weight: 600 !important;
        color: #495057 !important;
        white-space: nowrap !important;
        min-width: 0 !important;
    }
    
    .col-lg-3 .table td:last-child {
        width: 65% !important;
        word-break: break-word !important;
        overflow-wrap: anywhere !important;
        min-width: 0 !important;
    }
    
    .col-lg-3 .table small {
        font-size: 0.75rem !important;
        line-height: 1.2 !important;
        word-break: break-all !important;
        display: block !important;
    }
    
    /* Status badges styling */
    .col-lg-3 .badge {
        font-size: 0.7rem !important;
        padding: 0.25em 0.5em !important;
        white-space: nowrap !important;
        display: inline-block !important;
    }
    
    /* Ensure card headers are also responsive */
    .col-lg-3 .card-header {
        padding: 0.75rem 1rem !important;
        background-color: #f8f9fa !important;
        border-bottom: 1px solid #dee2e6 !important;
    }
    
    .col-lg-3 .card-header h6 {
        font-size: 0.9rem !important;
        margin-bottom: 0 !important;
        font-weight: 600 !important;
    }
</style>
{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            {% if is_public_view %}
                <a href="{% url 'filemanager:home' %}">
                    <i class="fas fa-home me-1"></i>Home
                </a>
            {% else %}
                <a href="{% url 'filemanager:dashboard' %}">
                    <i class="fas fa-home me-1"></i>Dashboard
                </a>
            {% endif %}
        </li>
        <li class="breadcrumb-item">
            {% if is_public_view %}
                <a href="{% url 'filemanager:public_file_detail' file.id %}">{{ file.name }}</a>
            {% else %}
                <a href="{% url 'filemanager:file_detail' file.id %}">{{ file.name }}</a>
            {% endif %}
        </li>
        <li class="breadcrumb-item active">Map View</li>
    </ol>
</nav>

<div class="row">
    <div class="col-lg-9">
        <!-- Map Controls -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                <i class="fas fa-map me-2"></i>{{ file.name }}
            </h5>
            <div class="d-flex align-items-center gap-2">
                <select id="mapLayerSelect" class="form-select form-select-sm" style="width: auto;">
                    <option value="osm">Default (OpenStreetMap)</option>
                    <option value="satellite">Satellite</option>
                    <option value="terrain">Terrain</option>
                    <option value="topo">Topographic</option>
                </select>
                <button id="testWMS" class="btn btn-sm btn-outline-info">
                    <i class="fas fa-bug me-1"></i>Test WMS
                </button>
            </div>
        </div>
        
        {% if file.gis_status == 'published' and geoserver_info or file.gis_status == 'processed' and geoserver_info %}
            <!-- Direct map container with explicit inline height -->
            <div id="map" style="height: 600px; width: 100%; border: 1px solid #ddd; background-color: #f0f0f0;"></div>
            
            <div class="mt-2">
                <small class="text-muted">
                    <strong>Status:</strong> {{ file.get_gis_status_display }} | 
                    <strong>CRS:</strong> {{ file.crs|default:"Unknown" }} |
                    <strong>Layer:</strong> {{ geoserver_info.workspace }}:{{ geoserver_info.layer_name }}
                </small>
            </div>
        {% else %}
            <div class="text-center py-5 border">
                <i class="fas fa-hourglass-half fa-3x text-info mb-3"></i>
                <h4>Processing in Progress</h4>
                <p class="text-muted">This spatial file is being processed. Please refresh the page.</p>
                <button class="btn btn-outline-primary" onclick="location.reload()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
        {% endif %}
    </div>

    <div class="col-lg-3">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">File Information</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Name:</strong></td>
                            <td>{{ file.name }}</td>
                        </tr>
                        <tr>
                            <td><strong>Type:</strong></td>
                            <td>{{ file.file_type|capfirst }}</td>
                        </tr>
                        <tr>
                            <td><strong>Size:</strong></td>
                            <td>{{ file.get_size_display }}</td>
                        </tr>
                        <tr>
                            <td><strong>Status:</strong></td>
                            <td>
                                {% if file.gis_status == 'published' %}
                                    <span class="badge bg-success">{{ file.get_gis_status_display }}</span>
                                {% elif file.gis_status == 'processed' %}
                                    <span class="badge bg-info">{{ file.get_gis_status_display }}</span>
                                {% elif file.gis_status == 'error' %}
                                    <span class="badge bg-danger">{{ file.get_gis_status_display }}</span>
                                {% else %}
                                    <span class="badge bg-warning">{{ file.get_gis_status_display }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% if file.crs %}
                        <tr>
                            <td><strong>CRS:</strong></td>
                            <td>{{ file.crs }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>

        {% if geoserver_info %}
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">Layer Information</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Workspace:</strong></td>
                            <td>{{ geoserver_info.workspace }}</td>
                        </tr>
                        <tr>
                            <td><strong>Layer:</strong></td>
                            <td><small>{{ geoserver_info.layer_name }}</small></td>
                        </tr>
                        <tr>
                            <td><strong>WMS URL:</strong></td>
                            <td><small>{{ geoserver_info.wms_url }}</small></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="card mt-3">
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'filemanager:download_file' file.id %}" class="btn btn-primary">
                        <i class="fas fa-download me-2"></i>Download File
                    </a>
                    <a href="{% url 'filemanager:file_detail' file.id %}" class="btn btn-outline-secondary">
                        <i class="fas fa-info-circle me-2"></i>View Details
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- OpenLayers JS -->
<script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>

{% if file.gis_status == 'published' and geoserver_info or file.gis_status == 'processed' and geoserver_info %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Creating OpenLayers map...');
    
    // Check if map container exists and has dimensions
    function checkMapContainer() {
        const mapDiv = document.getElementById('map');
        if (mapDiv) {
            const rect = mapDiv.getBoundingClientRect();
            console.log('Map container dimensions:', {
                width: rect.width,
                height: rect.height,
                offsetWidth: mapDiv.offsetWidth,
                offsetHeight: mapDiv.offsetHeight
            });
            return rect.width > 0 && rect.height > 0;
        }
        return false;
    }
    
    // Wait longer for the DOM to fully render and check dimensions
    setTimeout(function() {
        if (!checkMapContainer()) {
            console.log('Map container not ready, waiting longer...');
            setTimeout(function() {
                if (!checkMapContainer()) {
                    console.log('Map container still not ready, forcing initialization...');
                    // Force set height using JavaScript
                    const mapDiv = document.getElementById('map');
                    if (mapDiv) {
                        mapDiv.style.height = '600px';
                        mapDiv.style.width = '100%';
                        mapDiv.style.display = 'block';
                        console.log('Forced map container height, trying again...');
                        setTimeout(function() {
                            checkMapContainer();
                            initializeMap();
                        }, 100);
                    }
                } else {
                    initializeMap();
                }
            }, 500);
        } else {
            initializeMap();
        }
    }, 200);
    
    function initializeMap() {
        // Define UTM Zone 14N projection (EPSG:32614)
        const utmProjection = new ol.proj.Projection({
            code: 'EPSG:32614',
            extent: [166021.44, 0.00, 833978.56, 9329005.18],
            units: 'm'
        });
        ol.proj.addProjection(utmProjection);
        
        // Create individual base layers WITH native attribution
        const baseLayers = {
            'osm': new ol.layer.Tile({
                source: new ol.source.OSM(), // Use native OpenStreetMap attribution
                title: 'OpenStreetMap',
                visible: true
            }),
            'satellite': new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                    attributions: '© Esri, Maxar, Earthstar Geographics, and the GIS User Community'
                }),
                title: 'Satellite',
                visible: false
            }),
            'terrain': new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}',
                    attributions: '© Esri, USGS, NOAA'
                }),
                title: 'Terrain',
                visible: false
            }),
            'topo': new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',
                    attributions: '© Esri, HERE, Garmin, Intermap, increment P Corp., GEBCO, USGS, FAO, NPS, NRCAN, GeoBase, IGN, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
                }),
                title: 'Topographic',
                visible: false
            })
        };
        
        // Create WMS layer WITHOUT attribution
        const wmsLayer = new ol.layer.Tile({
            source: new ol.source.TileWMS({
                url: '{{ geoserver_info.wms_url }}',
                params: {
                    'LAYERS': '{{ geoserver_info.workspace }}:{{ geoserver_info.layer_name }}',
                    'TILED': true,
                    'FORMAT': 'image/png',
                    'TRANSPARENT': true
                },
                serverType: 'geoserver',
                crossOrigin: 'anonymous',
                attributions: [] // Remove WMS attribution
            }),
            title: '{{ file.name }}',
            opacity: 0.8
        });
        
        // Create map with individual layers
        const map = new ol.Map({
            target: 'map',
            layers: [
                baseLayers.osm, 
                baseLayers.satellite, 
                baseLayers.terrain, 
                baseLayers.topo, 
                wmsLayer
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([-99.5, 41.0]),
                zoom: 7,
                projection: 'EPSG:3857'
            })
        });
        
        // Remove all attribution controls completely
        const controlsToRemove = [];
        map.getControls().forEach(function(control) {
            if (control instanceof ol.control.Attribution) {
                controlsToRemove.push(control);
            }
        });
        controlsToRemove.forEach(function(control) {
            map.removeControl(control);
        });
        
        console.log('All attribution removed');
        
        // Try to get the layer extent from GeoServer
        function getLayerExtent() {
            const layerName = '{{ geoserver_info.workspace }}:{{ geoserver_info.layer_name }}';
            const url = '{{ geoserver_info.wms_url }}' + 
                '?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetCapabilities';
            
            console.log('Fetching layer capabilities from:', url);
            
            fetch(url)
                .then(response => response.text())
                .then(xmlText => {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                    
                    // Find the layer in the capabilities document
                    const layers = xmlDoc.querySelectorAll('Layer > Name');
                    let targetLayer = null;
                    
                    for (let layer of layers) {
                        if (layer.textContent === layerName) {
                            targetLayer = layer.parentElement;
                            break;
                        }
                    }
                    
                    if (targetLayer) {
                        // Look for BoundingBox or EX_GeographicBoundingBox
                        const bboxElement = targetLayer.querySelector('BoundingBox[CRS="EPSG:4326"], BoundingBox[CRS="CRS:84"], EX_GeographicBoundingBox');
                        
                        if (bboxElement) {
                            let minx, miny, maxx, maxy;
                            
                            if (bboxElement.tagName === 'EX_GeographicBoundingBox') {
                                minx = parseFloat(bboxElement.querySelector('westBoundLongitude').textContent);
                                miny = parseFloat(bboxElement.querySelector('southBoundLatitude').textContent);
                                maxx = parseFloat(bboxElement.querySelector('eastBoundLongitude').textContent);
                                maxy = parseFloat(bboxElement.querySelector('northBoundLatitude').textContent);
                            } else {
                                minx = parseFloat(bboxElement.getAttribute('minx'));
                                miny = parseFloat(bboxElement.getAttribute('miny'));
                                maxx = parseFloat(bboxElement.getAttribute('maxx'));
                                maxy = parseFloat(bboxElement.getAttribute('maxy'));
                            }
                            
                            console.log('Found layer extent (lat/lon):', [minx, miny, maxx, maxy]);
                            
                            // Update test WMS URL with actual extent
                            testWMSUrl = '{{ geoserver_info.wms_url }}' + 
                                '?SERVICE=WMS' +
                                '&VERSION=1.1.1' +
                                '&REQUEST=GetMap' +
                                '&LAYERS={{ geoserver_info.workspace }}:{{ geoserver_info.layer_name }}' +
                                '&STYLES=' +
                                '&FORMAT=image/png' +
                                '&TRANSPARENT=true' +
                                '&SRS=EPSG:4326' +
                                '&BBOX=' + [minx, miny, maxx, maxy].join(',') +
                                '&WIDTH=512' +
                                '&HEIGHT=512';
                            
                            console.log('Updated test WMS URL with actual extent:', testWMSUrl);
                            
                            // Transform to Web Mercator and zoom to it
                            const extent = ol.proj.transformExtent(
                                [minx, miny, maxx, maxy],
                                'EPSG:4326',
                                'EPSG:3857'
                            );
                            
                            console.log('Transformed extent (Web Mercator):', extent);
                            
                            map.getView().fit(extent, {
                                padding: [50, 50, 50, 50],
                                size: map.getSize(),
                                duration: 1000
                            });
                            
                            console.log('Zoomed to layer extent from GetCapabilities');
                        } else {
                            console.log('No bounding box found in capabilities, using default view');
                        }
                    } else {
                        console.log('Layer not found in capabilities document');
                    }
                })
                .catch(error => {
                    console.log('Failed to get capabilities:', error);
                    console.log('Using default view');
                });
        }
        
        // Call the function to get and zoom to the layer extent
        setTimeout(getLayerExtent, 1000); // Wait a bit for the map to initialize
        
        // Force map to update its size
        setTimeout(function() {
            map.updateSize();
            console.log('Map size updated');
        }, 100);
        
        // Add controls manually
        map.addControl(new ol.control.ScaleLine());
        map.addControl(new ol.control.FullScreen());
        
        console.log('Map created successfully');
        console.log('Base layer: OpenStreetMap');
        console.log('WMS layer: {{ geoserver_info.workspace }}:{{ geoserver_info.layer_name }}');
        console.log('WMS URL: {{ geoserver_info.wms_url }}');
        
        // Initialize dropdown layer selector
        setTimeout(function() {
            const layerSelect = document.getElementById('mapLayerSelect');
            if (layerSelect) {
                layerSelect.addEventListener('change', function() {
                    const selectedLayer = this.value;
                    console.log('Switching to layer:', selectedLayer);
                    
                    // Hide all base layers
                    Object.values(baseLayers).forEach(layer => {
                        layer.setVisible(false);
                    });
                    
                    // Show selected layer
                    if (baseLayers[selectedLayer]) {
                        baseLayers[selectedLayer].setVisible(true);
                        console.log('Layer switched to:', selectedLayer);
                    } else {
                        console.log('Layer not found:', selectedLayer);
                    }
                });
                
                console.log('Dropdown layer selector initialized');
                console.log('Available base layers:', Object.keys(baseLayers));
            } else {
                console.log('Layer dropdown not found');
            }
        }, 100);
        
        // Add WMS test functionality
        document.getElementById('testWMS').addEventListener('click', function() {
            console.log('=== WMS DEBUGGING INFO ===');
            console.log('Layer visible:', wmsLayer.getVisible());
            console.log('Layer opacity:', wmsLayer.getOpacity());
            console.log('Layer extent:', wmsLayer.getExtent());
            console.log('Map zoom:', map.getView().getZoom());
            console.log('Map center:', ol.proj.toLonLat(map.getView().getCenter()));
            
            // Force refresh the layer
            wmsLayer.getSource().refresh();
            console.log('Layer refreshed');
            
            // Open test WMS URL in new tab
            window.open(testWMSUrl, '_blank');
        });
        
        // Auto-zoom to layer extent when map loads
        console.log('Auto-zooming to layer extent...');
        setTimeout(function() {
            getLayerExtent();
        }, 1000);
        
        // Add click handler to show coordinates
        map.on('click', function(evt) {
            const coordinate = evt.coordinate;
            const lonLat = ol.proj.toLonLat(coordinate);
            console.log('Clicked at:', lonLat[1].toFixed(6) + ', ' + lonLat[0].toFixed(6));
        });
        
        // Add extensive WMS debugging
        let loading = 0;
        wmsLayer.getSource().on('tileloadstart', function(event) {
            loading++;
            if (loading === 1) {
                console.log('Loading WMS tiles...');
            }
            console.log('WMS tile URL:', event.tile.src_);
        });
        
        wmsLayer.getSource().on('tileloadend', function(event) {
            loading--;
            console.log('WMS tile loaded successfully:', event.tile.src_);
            if (loading === 0) {
                console.log('All WMS tiles loaded');
            }
        });
        
        wmsLayer.getSource().on('tileloaderror', function(event) {
            loading--;
            console.log('WMS tile load error:', event.tile.src_);
            console.log('Error details:', event);
        });
        
        // Test a direct WMS GetMap request - will be updated dynamically
        let testWMSUrl = '{{ geoserver_info.wms_url }}' + 
            '?SERVICE=WMS' +
            '&VERSION=1.1.1' +
            '&REQUEST=GetMap' +
            '&LAYERS={{ geoserver_info.workspace }}:{{ geoserver_info.layer_name }}' +
            '&STYLES=' +
            '&FORMAT=image/png' +
            '&TRANSPARENT=true' +
            '&SRS=EPSG:4326' +
            '&BBOX=-180,-90,180,90' + // Default world extent
            '&WIDTH=512' +
            '&HEIGHT=512';
        
        console.log('Test WMS URL (copy to browser to test):', testWMSUrl);
        
        // Check if layer is actually visible
        console.log('WMS Layer visible:', wmsLayer.getVisible());
        console.log('WMS Layer opacity:', wmsLayer.getOpacity());
        console.log('WMS Layer source URL:', wmsLayer.getSource().getUrls());
        
        console.log('OpenLayers map initialization complete');
    } // End of initializeMap function
});
</script>
{% endif %}
{% endblock %}