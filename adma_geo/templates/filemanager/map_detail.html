{% extends 'base.html' %}
{% load static %}

{% block title %}{{ map_obj.name }} - ADMA GEO{% endblock %}

{% block extra_css %}
<style>
    .map-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .layer-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        transition: all 0.2s ease;
    }
    
    .layer-item:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-color: #d00000;
    }
    
    .layer-file-info {
        cursor: pointer;
        text-decoration: none;
        color: inherit;
        display: block;
        flex-grow: 1;
    }
    
    .layer-file-info:hover {
        color: #d00000;
        text-decoration: none;
    }
    
    .layer-file-info:hover h6 {
        color: #d00000;
    }
    
    /* Add Layer Modal Styles - Isolated CSS */
    .modal-file-item {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 8px 12px;
        margin-bottom: 8px;
        background: white;
        transition: border-color 0.15s ease-in-out;
    }
    
    .modal-file-item:hover {
        border-color: #007bff;
        background-color: #f8f9fa;
    }
    
    .modal-file-item input[type="checkbox"]:checked + .modal-file-label {
        color: #007bff;
    }
    
    .modal-file-label {
        display: block;
        margin-bottom: 0;
        cursor: pointer;
        font-size: 14px;
        line-height: 1.4;
    }
    
    .modal-file-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 2px;
    }
    
    .modal-file-type {
        display: inline-block;
        background: #17a2b8;
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 3px;
        margin-right: 8px;
        font-weight: 500;
    }
    
    .modal-file-meta {
        font-size: 11px;
        color: #6c757d;
        margin-top: 2px;
    }
    
    .modal-file-size {
        font-size: 10px;
        color: #6c757d;
        text-align: right;
    }
    
    /* Modal positioning and size */
    #addLayerModal .modal-dialog {
        max-width: 800px;
        margin: 2rem auto;
        height: calc(100vh - 4rem);
        display: flex;
        align-items: flex-start;
    }
    
    #addLayerModal .modal-content {
        height: 600px;
        max-height: calc(100vh - 4rem);
        display: flex;
        flex-direction: column;
    }
    
    #addLayerModal .modal-body {
        flex: 1;
        overflow-y: auto;
        max-height: 450px;
    }
    
    #addLayerModal .modal-header {
        flex-shrink: 0;
        border-bottom: 2px solid #e9ecef;
    }
    
    #addLayerModal .modal-footer {
        flex-shrink: 0;
        border-top: 2px solid #e9ecef;
    }
    
    /* Files sections styling */
    .files-section {
        max-height: 300px;
        overflow-y: auto;
        padding-right: 0.5rem;
    }
    
    .files-section::-webkit-scrollbar {
        width: 6px;
    }
    
    .files-section::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    .files-section::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }
    
    .files-section::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    
    /* Empty state styling */
    .files-section .text-muted {
        text-align: center;
        padding: 2rem;
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        font-style: italic;
    }
    
    /* Map visualization styles */
    .map-container {
        height: 500px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
    }
    
    .map-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: rgba(255,255,255,0.9);
        border-radius: 8px;
        padding: 0.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .basemap-selector {
        background: rgba(255,255,255,0.9);
        border-radius: 6px;
        margin-bottom: 1rem;
    }
    
    /* OpenLayers control positioning */
    #map .ol-attribution {
        background: rgba(255,255,255,0.8) !important;
        border-radius: 0px !important;
        bottom: 0px !important;
        left: 0px !important;
        right: 0px !important;
        width: 100% !important;
        max-width: 100% !important;
        font-size: 11px !important;
        line-height: 1.2 !important;
        white-space: nowrap !important;
        padding: 4px !important;
        text-align: center !important;
        margin: 0 !important;
    }
    
    #map .ol-zoom {
        position: absolute !important;
        top: 10px !important;
        right: 10px !important;
        left: auto !important;
        bottom: auto !important;
        background: rgba(255, 255, 255, 0.9) !important;
        border-radius: 6px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
        border: 1px solid rgba(0,0,0,0.1) !important;
        margin: 0 !important;
    }
    
    #map .ol-full-screen {
        position: absolute !important;
        top: 10px !important;
        right: 60px !important;
        left: auto !important;
        bottom: auto !important;
        background: rgba(255, 255, 255, 0.9) !important;
        border-radius: 6px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
        border: 1px solid rgba(0,0,0,0.1) !important;
        margin: 0 !important;
    }
    
    .layer-handle {
        cursor: grab;
        color: #6c757d;
    }
    
    .layer-handle:active {
        cursor: grabbing;
    }
    
    .layer-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    .opacity-slider {
        width: 100px;
    }
    
    .file-type-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        background-color: #28a745;
        color: white;
    }
    
    .map-stats {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
    }
    
    .stat-item {
        text-align: center;
        padding: 1rem;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #d00000;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
</style>

<!-- OpenLayers CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid mt-4">
    <!-- Map Header -->
    <div class="map-header">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1 class="mb-2">{{ map_obj.name }}</h1>
                {% if map_obj.description %}
                <p class="mb-0 opacity-75">{{ map_obj.description }}</p>
                {% endif %}
            </div>
            <div class="text-end">
                <span id="mapHeaderBadge" class="badge {% if map_obj.is_public %}bg-success{% else %}bg-secondary{% endif %} fs-6 mb-2">
                    {% if map_obj.is_public %}
                    <i class="fas fa-globe me-1"></i>Public
                    {% else %}
                    <i class="fas fa-lock me-1"></i>Private
                    {% endif %}
                </span>
                <br>
                <small class="opacity-75">by {{ map_obj.owner.username }} • {{ map_obj.updated_at|date:"M d, Y" }}</small>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Map Content -->
        <div class="col-lg-8">
            <!-- Action Buttons -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <a href="{% url 'filemanager:maps_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Maps
                    </a>
                </div>
                <div class="d-flex gap-2">
                    {% if can_edit %}
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-cog me-1"></i>Actions
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="editMapSettings()">
                                <i class="fas fa-edit me-2"></i>Edit Settings
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="toggleMapVisibility()">
                                <i class="fas fa-eye me-2"></i>Toggle Visibility
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteMap()">
                                <i class="fas fa-trash me-2"></i>Delete Map
                            </a></li>
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Map Layers -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-layers me-2"></i>Map Layers
                        <span class="badge bg-primary">{{ map_layers.count }}</span>
                    </h5>
                    {% if can_edit %}
                    <button class="btn btn-outline-primary btn-sm" onclick="addNewLayer()">
                        <i class="fas fa-plus me-1"></i>Add Layer
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if map_layers %}
                    <div id="layersList">
                        {% for layer in map_layers %}
                        <div class="layer-item" data-layer-id="{{ layer.id }}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center flex-grow-1">
                                    {% if can_edit %}
                                    <i class="fas fa-grip-vertical layer-handle me-3"></i>
                                    {% endif %}
                                    
                                    <!-- Clickable file info -->
                                    {% if layer.file.owner == request.user %}
                                        <a href="{% url 'filemanager:file_detail' layer.file.id %}" class="layer-file-info">
                                    {% else %}
                                        <a href="{% url 'filemanager:public_file_detail' layer.file.id %}" class="layer-file-info">
                                    {% endif %}
                                        <h6 class="mb-1">{{ layer.file.name }}</h6>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="file-type-badge">{{ layer.file.file_type|upper }}</span>
                                            {% if layer.file.folder %}
                                            <small class="text-muted">{{ layer.file.folder.get_full_path }}</small>
                                            {% endif %}
                                            {% if layer.file.owner != request.user %}
                                            <span class="badge bg-success-subtle text-success-emphasis">Public</span>
                                            {% endif %}
                                        </div>
                                    </a>
                                </div>
                                
                                {% if can_edit %}
                                <div class="layer-controls">
                                    <div class="d-flex align-items-center">
                                        <label class="form-label mb-0 me-2 small">Opacity:</label>
                                        <input type="range" class="form-range opacity-slider" 
                                               min="0" max="1" step="0.1" value="{{ layer.opacity }}"
                                               onchange="updateLayerOpacity('{{ layer.id }}', this.value)">
                                        <span class="ms-1 small" id="opacity-value-{{ layer.id }}">{{ layer.opacity|floatformat:1 }}</span>
                                    </div>
                                    
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" 
                                               {% if layer.is_visible %}checked{% endif %}
                                               onchange="toggleLayerVisibility('{{ layer.id }}', this.checked)">
                                        <label class="form-check-label small">Visible</label>
                                    </div>
                                    
                                    <button class="btn btn-outline-danger btn-sm ms-2" 
                                            onclick="removeLayer('{{ layer.id }}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                {% else %}
                                <div class="text-muted">
                                    <small>Order: {{ layer.layer_order }} • Opacity: {{ layer.opacity }}
                                    {% if layer.is_visible %} • Visible{% else %} • Hidden{% endif %}</small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-layer-group text-muted" style="font-size: 3rem;"></i>
                        <h5 class="mt-3 text-muted">No Layers in Map</h5>
                        <p class="text-muted">This map doesn't contain any layers yet.</p>
                        {% if can_edit %}
                        <button class="btn btn-primary" onclick="addNewLayer()">
                            <i class="fas fa-plus me-1"></i>Add First Layer
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Map Visualization -->
            <div class="card mb-4 mt-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-map me-2"></i>Map Visualization</h5>
                        
                        <!-- Basemap Selector -->
                        <div class="basemap-selector">
                            <select class="form-select form-select-sm" id="basemapSelector" onchange="changeBasemap()">
                                <option value="osm">OpenStreetMap</option>
                                <option value="satellite" selected>Satellite</option>
                                <option value="terrain">Terrain</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Map Container -->
                    <div class="map-container">
                        <div id="map" style="width: 100%; height: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Map Statistics -->
            <div class="map-stats mb-4">
                <h5 class="mb-3"><i class="fas fa-chart-bar me-2"></i>Map Statistics</h5>
                <div class="row">
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="stat-number">{{ map_obj.layer_count }}</div>
                            <div class="stat-label">Layers</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="stat-number">{{ map_obj.file_count }}</div>
                            <div class="stat-label">Files</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map Information -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Map Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Coordinate System:</strong><br>
                        <small class="text-muted">EPSG:3857 (Web Mercator)</small>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Total Layers:</strong><br>
                        <small class="text-muted" id="total-layers-count">{{ map_layers.count }}</small>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Created:</strong><br>
                        <small class="text-muted">{{ map_obj.created_at|date:"F d, Y \a\t g:i A" }}</small>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Last Updated:</strong><br>
                        <small class="text-muted">{{ map_obj.updated_at|date:"F d, Y \a\t g:i A" }}</small>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Owner:</strong><br>
                        <small class="text-muted">{{ map_obj.owner.username }}</small>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Visibility:</strong><br>
                        {% if can_edit %}
                        <!-- Private/Public Toggle -->
                        <div class="form-check form-switch mt-2">
                            <input class="form-check-input" type="checkbox" id="mapVisibilityToggle" 
                                   {% if map_obj.is_public %}checked{% endif %}
                                   onchange="toggleMapVisibility()"
                                   onclick="console.log('Toggle clicked directly - before:', this.checked); setTimeout(() => console.log('Toggle clicked directly - after:', this.checked), 5);">
                            <label class="form-check-label" for="mapVisibilityToggle">
                                <span id="visibilityLabel">
                                    {% if map_obj.is_public %}
                                    <i class="fas fa-globe me-1 text-success"></i>Public
                                    {% else %}
                                    <i class="fas fa-lock me-1 text-secondary"></i>Private
                                    {% endif %}
                                </span>
                            </label>
                        </div>
                        {% else %}
                        {% if map_obj.is_public %}
                        <span class="badge bg-success"><i class="fas fa-globe me-1"></i>Public</span>
                        {% else %}
                        <span class="badge bg-secondary"><i class="fas fa-lock me-1"></i>Private</span>
                        {% endif %}
                        {% endif %}
                    </div>
                    
                    {% if map_obj.center_lat and map_obj.center_lng %}
                    <div class="mb-3">
                        <strong>Map Center:</strong><br>
                        <small class="text-muted">{{ map_obj.center_lat|floatformat:4 }}, {{ map_obj.center_lng|floatformat:4 }}</small>
                    </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <strong>GeoServer Layer Group:</strong><br>
                        <small class="text-muted font-monospace">{{ map_obj.geoserver_layer_group_name }}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Layer Modal -->
<div class="modal fade" id="addLayerModal" tabindex="-1" aria-labelledby="addLayerModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addLayerModalLabel">
                    <i class="fas fa-plus me-2"></i>Add Layers to Map
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="layerLoadingSpinner" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading available layers...</p>
                </div>
                
                <div id="layerContent" style="display: none;">
                    <!-- Search Bar -->
                    <div class="mb-3 sticky-top bg-white pb-2" style="top: 0; z-index: 10;">
                        <input type="text" class="form-control" id="layerSearch" placeholder="Search layers by name...">
                    </div>
                    
                    <!-- Files Container -->
                    <div class="files-container">
                        <!-- Your Files Tab -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3 bg-light px-2 py-1 rounded">
                                <i class="fas fa-user me-1"></i>Your Spatial Files
                            </h6>
                            <div id="userFilesContainer" class="files-section">
                                <!-- User files will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Public Files Tab -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3 bg-light px-2 py-1 rounded">
                                <i class="fas fa-globe me-1"></i>Public Spatial Files
                            </h6>
                            <div id="publicFilesContainer" class="files-section">
                                <!-- Public files will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="layerError" style="display: none;" class="alert alert-danger">
                    Failed to load available layers. Please try again.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="addSelectedLayers" disabled>
                    <i class="fas fa-plus me-1"></i>Add Selected Layers
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function updateLayerOpacity(layerId, opacity) {
    // Update layer opacity via AJAX
    fetch(`/api/maps/{{ map_obj.id }}/layers/${layerId}/opacity/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            opacity: parseFloat(opacity)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the opacity display value
            const opacityValueElement = document.getElementById(`opacity-value-${layerId}`);
            if (opacityValueElement) {
                opacityValueElement.textContent = parseFloat(opacity).toFixed(1);
            }
            
            // Update the map layer opacity
            updateMapLayerOpacity(layerId, parseFloat(opacity));
            
            console.log(`Updated layer ${layerId} opacity to ${opacity}`);
        } else {
            console.error('Error updating layer opacity:', data.error);
            showToast('Error updating layer opacity', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error updating layer opacity', 'error');
    });
}

function toggleLayerVisibility(layerId, visible) {
    // Toggle layer visibility via AJAX
    fetch(`/api/maps/{{ map_obj.id }}/layers/${layerId}/visibility/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            visible: visible
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the map layer visibility
            updateMapLayerVisibility(layerId, visible);
            
            console.log(`Toggled layer ${layerId} visibility to ${visible}`);
        } else {
            console.error('Error toggling layer visibility:', data.error);
            showToast('Error updating layer visibility', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error updating layer visibility', 'error');
    });
}

function removeLayer(layerId) {
    if (confirm('Are you sure you want to remove this layer from the map?')) {
        // Remove layer via AJAX
        fetch(`/api/maps/{{ map_obj.id }}/layers/${layerId}/remove/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove layer from map
                if (mapLayers[layerId]) {
                    map.removeLayer(mapLayers[layerId]);
                    delete mapLayers[layerId];
                }
                
                // Remove layer from UI
                document.querySelector(`[data-layer-id="${layerId}"]`).remove();
                showToast('Layer removed successfully', 'success');
                
                // Update layer count without page reload
                updateLayerCount();
            } else {
                showToast('Error removing layer: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error removing layer');
        });
    }
}

function addNewLayer() {
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('addLayerModal'));
    modal.show();
    
    // Reset modal state
    document.getElementById('layerLoadingSpinner').style.display = 'block';
    document.getElementById('layerContent').style.display = 'none';
    document.getElementById('layerError').style.display = 'none';
    document.getElementById('addSelectedLayers').disabled = true;
    
    // Load available layers
    fetch(`/api/maps/{{ map_obj.id }}/available-layers/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                populateLayerModal(data.user_files, data.public_files);
            } else {
                showLayerError();
            }
        })
        .catch(error => {
            console.error('Error loading layers:', error);
            showLayerError();
        });
}

function populateLayerModal(userFiles, publicFiles) {
    // Hide loading spinner and show content
    document.getElementById('layerLoadingSpinner').style.display = 'none';
    document.getElementById('layerContent').style.display = 'block';
    
    // Populate user files
    const userContainer = document.getElementById('userFilesContainer');
    if (userFiles.length === 0) {
        userContainer.innerHTML = '<p class="text-muted">No spatial files available</p>';
    } else {
        userContainer.innerHTML = userFiles.map(file => createFileCheckbox(file, false)).join('');
    }
    
    // Populate public files
    const publicContainer = document.getElementById('publicFilesContainer');
    if (publicFiles.length === 0) {
        publicContainer.innerHTML = '<p class="text-muted">No public spatial files available</p>';
    } else {
        publicContainer.innerHTML = publicFiles.map(file => createFileCheckbox(file, true)).join('');
    }
    
    // Add event listeners
    setupLayerModalEvents();
}

function createFileCheckbox(file, isPublic) {
    const ownerInfo = isPublic ? ` • by ${file.owner}` : '';
    const folderInfo = file.folder ? `${file.folder}/` : '';
    
    return `
        <div class="modal-file-item" data-file-name="${file.name.toLowerCase()}">
            <input type="checkbox" value="${file.id}" id="file_${file.id}" style="float: left; margin-right: 8px; margin-top: 2px;">
            <label class="modal-file-label" for="file_${file.id}">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1; min-width: 0;">
                        <div class="modal-file-name">${file.name}</div>
                        <div style="margin-top: 2px;">
                            <span class="modal-file-type">${file.file_type.toUpperCase()}</span>
                            <span class="modal-file-meta">${folderInfo}${ownerInfo}</span>
                        </div>
                    </div>
                    <div class="modal-file-size" style="margin-left: 12px; min-width: 80px;">
                        <div>${file.size}</div>
                        <div style="margin-top: 1px;">${file.created_at}</div>
                    </div>
                </div>
            </label>
        </div>
    `;
}

function setupLayerModalEvents() {
    // Search functionality
    const searchInput = document.getElementById('layerSearch');
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const checkboxes = document.querySelectorAll('.modal-file-item');
        
        checkboxes.forEach(checkbox => {
            const fileName = checkbox.dataset.fileName;
            if (fileName.includes(searchTerm)) {
                checkbox.style.display = 'block';
            } else {
                checkbox.style.display = 'none';
            }
        });
    });
    
    // Checkbox change events
    const checkboxes = document.querySelectorAll('#addLayerModal input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateAddButton);
    });
    
    // Add selected layers button
    document.getElementById('addSelectedLayers').addEventListener('click', addSelectedLayersToMap);
}

function updateAddButton() {
    const checkedBoxes = document.querySelectorAll('#addLayerModal input[type="checkbox"]:checked');
    const addButton = document.getElementById('addSelectedLayers');
    
    if (checkedBoxes.length > 0) {
        addButton.disabled = false;
        addButton.innerHTML = `<i class="fas fa-plus me-1"></i>Add ${checkedBoxes.length} Layer${checkedBoxes.length > 1 ? 's' : ''}`;
    } else {
        addButton.disabled = true;
        addButton.innerHTML = '<i class="fas fa-plus me-1"></i>Add Selected Layers';
    }
}

function addSelectedLayersToMap() {
    const checkedBoxes = document.querySelectorAll('#addLayerModal input[type="checkbox"]:checked');
    const fileIds = Array.from(checkedBoxes).map(cb => cb.value);
    
    if (fileIds.length === 0) return;
    
    // Disable button and show loading
    const addButton = document.getElementById('addSelectedLayers');
    addButton.disabled = true;
    addButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Adding Layers...';
    
    // Send AJAX request
    fetch(`/api/maps/{{ map_obj.id }}/add-layers/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            file_ids: fileIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add new layers to the map dynamically without page reload
            data.added_layers.forEach(layer => {
                addNewLayerToMap(layer);
            });
            
            // Clear all selected checkboxes
            const checkedBoxes = document.querySelectorAll('#addLayerModal input[type="checkbox"]:checked');
            checkedBoxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Reset the add button
            updateAddButton();
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('addLayerModal')).hide();
            showToast(data.message, 'success');
            
            // No page reload - layers are added dynamically
            console.log('Added layers without changing zoom level');
        } else {
            showToast('Error: ' + data.error, 'error');
            addButton.disabled = false;
            updateAddButton();
        }
    })
    .catch(error => {
        console.error('Error adding layers:', error);
        showToast('Error adding layers', 'error');
        addButton.disabled = false;
        updateAddButton();
    });
}

function showLayerError() {
    document.getElementById('layerLoadingSpinner').style.display = 'none';
    document.getElementById('layerError').style.display = 'block';
}

function editMapSettings() {
    // TODO: Implement edit settings modal
    alert('Edit settings functionality coming soon!');
}

// CSRF token helper function
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function toggleMapVisibility() {
    try {
        const toggle = document.getElementById('mapVisibilityToggle');
        const label = document.getElementById('visibilityLabel');
        
        console.log('=== MAP TOGGLE DEBUG ===');
        console.log('Toggle element:', toggle);
        console.log('Map ID:', '{{ map_obj.id }}');
        
        if (!toggle) {
            console.error('Toggle element not found!');
            return;
        }
        
        if (!label) {
            console.error('Label element not found!');
            return;
        }
        
        // Get current state from the backend data, not the checkbox
        const currentlyPublic = label.innerHTML.includes('fa-globe');
        const newIsPublic = !currentlyPublic; // Toggle to opposite
        
        console.log('Current state (from label):', currentlyPublic ? 'Public' : 'Private');
        console.log('Target state:', newIsPublic ? 'Public' : 'Private');
        console.log('Toggle checked before request:', toggle.checked);
        
        const csrfToken = getCookie('csrftoken');
        console.log('CSRF Token:', csrfToken ? 'Found' : 'NOT FOUND');
        
        // Send AJAX request to update visibility
        console.log('Sending request with is_public:', newIsPublic);
            fetch(`/api/maps/{{ map_obj.id }}/toggle-visibility/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    is_public: newIsPublic
                })
            })
    .then(response => response.json())
    .then(data => {
        console.log('Backend response:', data);
        if (data.success) {
            // Update UI based on actual backend response
            toggle.checked = data.is_public;
            if (data.is_public) {
                label.innerHTML = '<i class="fas fa-globe me-1 text-success"></i>Public';
            } else {
                label.innerHTML = '<i class="fas fa-lock me-1 text-secondary"></i>Private';
            }
            
            // Update header badge
            const headerBadge = document.getElementById('mapHeaderBadge');
            if (headerBadge) {
                if (data.is_public) {
                    headerBadge.className = 'badge bg-success fs-6 mb-2';
                    headerBadge.innerHTML = '<i class="fas fa-globe me-1"></i>Public';
                } else {
                    headerBadge.className = 'badge bg-secondary fs-6 mb-2';
                    headerBadge.innerHTML = '<i class="fas fa-lock me-1"></i>Private';
                }
                console.log('Header badge updated to:', data.is_public ? 'Public' : 'Private');
            }
            
            console.log('UI updated - toggle.checked:', toggle.checked, 'data.is_public:', data.is_public);
            
            // Show success message
            const message = data.is_public ? 'Map is now public' : 'Map is now private';
            showToast('success', message);
        } else {
            // Revert the toggle on error
            toggle.checked = currentlyPublic;
            label.innerHTML = currentlyPublic ? '<i class="fas fa-globe me-1 text-success"></i>Public' : '<i class="fas fa-lock me-1 text-secondary"></i>Private';
            
            // Revert header badge on error
            const headerBadge = document.getElementById('mapHeaderBadge');
            if (headerBadge) {
                if (currentlyPublic) {
                    headerBadge.className = 'badge bg-success fs-6 mb-2';
                    headerBadge.innerHTML = '<i class="fas fa-globe me-1"></i>Public';
                } else {
                    headerBadge.className = 'badge bg-secondary fs-6 mb-2';
                    headerBadge.innerHTML = '<i class="fas fa-lock me-1"></i>Private';
                }
            }
            
            showToast('error', 'Error updating map visibility: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Revert the toggle on error
        toggle.checked = currentlyPublic;
        label.innerHTML = currentlyPublic ? '<i class="fas fa-globe me-1 text-success"></i>Public' : '<i class="fas fa-lock me-1 text-secondary"></i>Private';
        
        // Revert header badge on error
        const headerBadge = document.getElementById('mapHeaderBadge');
        if (headerBadge) {
            if (currentlyPublic) {
                headerBadge.className = 'badge bg-success fs-6 mb-2';
                headerBadge.innerHTML = '<i class="fas fa-globe me-1"></i>Public';
            } else {
                headerBadge.className = 'badge bg-secondary fs-6 mb-2';
                headerBadge.innerHTML = '<i class="fas fa-lock me-1"></i>Private';
            }
        }
        showToast('error', 'Error updating map visibility');
    });
    } catch (error) {
        console.error('JavaScript error in toggleMapVisibility:', error);
        showToast('error', 'JavaScript error: ' + error.message);
    }
}


function deleteMap() {
    if (confirm('Are you sure you want to delete this map? This action cannot be undone.')) {
        fetch(`/api/maps/{{ map_obj.id }}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '{% url "filemanager:maps_list" %}';
            } else {
                alert('Error deleting map: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting map');
        });
    }
}

// Map initialization
let map;
let basemapLayer;
let mapLayers = {}; // Track map layers by layer ID

function initializeMap() {
    // Initialize base map layer with satellite imagery
    basemapLayer = new ol.layer.Tile({
        source: new ol.source.XYZ({
            url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
            attributions: '© Esri, Maxar, Earthstar Geographics, and the GIS User Community'
        })
    });
    
    // Map configuration
    const mapConfig = {
        center_lat: {{ map_obj.center_lat|default:"40.0" }},
        center_lng: {{ map_obj.center_lng|default:"-100.0" }},
        zoom_level: {{ map_obj.zoom_level|default:"4" }},
        bbox_min_lat: {{ map_obj.bbox_min_lat|default:"null" }},
        bbox_max_lat: {{ map_obj.bbox_max_lat|default:"null" }},
        bbox_min_lng: {{ map_obj.bbox_min_lng|default:"null" }},
        bbox_max_lng: {{ map_obj.bbox_max_lng|default:"null" }}
    };
    
    // Initialize map
    map = new ol.Map({
        target: 'map',
        layers: [basemapLayer],
        controls: [], // Start with no default controls
        view: new ol.View({
            center: ol.proj.fromLonLat([mapConfig.center_lng, mapConfig.center_lat]),
            zoom: 6  // Always start at zoom level 6
        })
    });
    
    // Add controls manually
    map.addControl(new ol.control.Zoom());
    map.addControl(new ol.control.Attribution({
        collapsible: false
    }));
    map.addControl(new ol.control.ScaleLine());
    map.addControl(new ol.control.FullScreen());
    
    // Add WMS layers for each layer
    {% for layer in map_layers %}
    {% if layer.file.geoserver_layer_name %}
    addWMSLayer('{{ layer.id }}', '{{ layer.file.geoserver_workspace }}', '{{ layer.file.geoserver_layer_name }}', '{{ layer.file.name }}', {{ layer.opacity }}, {{ layer.is_visible|yesno:"true,false" }});
    {% endif %}
    {% endfor %}
    
    // Only zoom to bounding box on initial load (not when layers are added/removed)
    if (mapConfig.bbox_min_lat !== null && mapConfig.bbox_max_lat !== null && 
        mapConfig.bbox_min_lng !== null && mapConfig.bbox_max_lng !== null && 
        typeof window.mapInitialized === 'undefined') {
        
        // Mark map as initialized to prevent future auto-zooming
        window.mapInitialized = true;
        
        setTimeout(function() {
            const extent = ol.proj.transformExtent([
                mapConfig.bbox_min_lng, mapConfig.bbox_min_lat,
                mapConfig.bbox_max_lng, mapConfig.bbox_max_lat
            ], 'EPSG:4326', 'EPSG:3857');
            
            map.getView().fit(extent, {
                padding: [50, 50, 50, 50],
                duration: 2000,  // 2 second smooth animation
                maxZoom: 18
            });
            
            console.log('Initial zoom from 6 to optimal level for bounding box:', [
                mapConfig.bbox_min_lng, mapConfig.bbox_min_lat,
                mapConfig.bbox_max_lng, mapConfig.bbox_max_lat
            ]);
        }, 500);
    }
}

function addWMSLayer(layerId, workspace, layerName, displayName, opacity, visible) {
    const wmsLayer = new ol.layer.Tile({
        source: new ol.source.TileWMS({
            url: '{{ request.scheme }}://{{ request.get_host }}/geoserver/wms',
            params: {
                'LAYERS': workspace + ':' + layerName,
                'FORMAT': 'image/png',
                'TRANSPARENT': true,
                'VERSION': '1.1.1',
                'SRS': 'EPSG:3857'
            },
            serverType: 'geoserver'
        }),
        opacity: opacity,
        visible: visible
    });
    
    // Store reference to layer
    mapLayers[layerId] = wmsLayer;
    
    map.addLayer(wmsLayer);
    return wmsLayer;
}

function updateMapLayerOpacity(layerId, opacity) {
    if (mapLayers[layerId]) {
        mapLayers[layerId].setOpacity(opacity);
    }
}

function updateMapLayerVisibility(layerId, visible) {
    if (mapLayers[layerId]) {
        mapLayers[layerId].setVisible(visible);
    }
}

function addNewLayerToMap(layerData) {
    // Add layer to OpenLayers map
    const wmsLayer = addWMSLayer(
        layerData.id, 
        layerData.workspace, 
        layerData.geoserver_layer_name, 
        layerData.name, 
        layerData.opacity, 
        layerData.is_visible
    );
    
    // Add layer to UI by creating a new layer item in the layers panel
    addLayerToUI(layerData);
    
    console.log(`Added layer ${layerData.name} to map without changing zoom`);
}

function addLayerToUI(layerData) {
    // Find the layers list container
    let layersContainer = document.getElementById('layersList');
    
    // If no layers list exists, find the map layers card body
    if (!layersContainer) {
        // Find all card headers and look for the one containing "Map Layers"
        const cardHeaders = document.querySelectorAll('.card-header');
        let mapLayersCardBody = null;
        
        for (let header of cardHeaders) {
            const h5 = header.querySelector('h5');
            if (h5 && h5.textContent.includes('Map Layers')) {
                mapLayersCardBody = header.nextElementSibling;
                break;
            }
        }
        
        if (mapLayersCardBody) {
            // Remove any "No layers" message
            const noLayersMessage = mapLayersCardBody.querySelector('.text-center.py-4');
            if (noLayersMessage) {
                noLayersMessage.remove();
            }
            
            // Create the layers list container if it doesn't exist
            layersContainer = mapLayersCardBody.querySelector('#layersList');
            if (!layersContainer) {
                mapLayersCardBody.innerHTML = '<div id="layersList"></div>';
                layersContainer = document.getElementById('layersList');
            }
        }
    }
    
    if (!layersContainer) {
        console.error('Could not find layers container');
        return;
    }
    
    // Create new layer element
    const layerHtml = `
        <div class="layer-item" data-layer-id="${layerData.id}">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center flex-grow-1">
                    <i class="fas fa-grip-vertical layer-handle me-3"></i>
                    
                    <div class="layer-file-info" style="pointer-events: none;">
                        <h6 class="mb-1">${layerData.name}</h6>
                        <div class="d-flex align-items-center gap-2">
                            <span class="file-type-badge">${layerData.file_type.toUpperCase()}</span>
                        </div>
                    </div>
                </div>
                
                <div class="layer-controls">
                    <div class="d-flex align-items-center">
                        <label class="form-label mb-0 me-2 small">Opacity:</label>
                        <input type="range" class="form-range opacity-slider" 
                               min="0" max="1" step="0.1" value="${layerData.opacity}"
                               onchange="updateLayerOpacity('${layerData.id}', this.value)">
                        <span class="ms-1 small" id="opacity-value-${layerData.id}">${layerData.opacity.toFixed(1)}</span>
                    </div>
                    
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" 
                               ${layerData.is_visible ? 'checked' : ''}
                               onchange="toggleLayerVisibility('${layerData.id}', this.checked)">
                        <label class="form-check-label small">Visible</label>
                    </div>
                    
                    <button class="btn btn-outline-danger btn-sm ms-2" 
                            onclick="removeLayer('${layerData.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Add the new layer to the container
    layersContainer.insertAdjacentHTML('beforeend', layerHtml);
    
    console.log(`Added layer ${layerData.name} to UI`);
    
    // Update layer count
    updateLayerCount();
}

function updateLayerCount() {
    // Update layer count displays
    const layerCount = Object.keys(mapLayers).length;
    
    // Update the total layers count in the map information panel
    const totalLayersElement = document.getElementById('total-layers-count');
    if (totalLayersElement) {
        totalLayersElement.textContent = layerCount;
    }
    
    // Update the badge in the Map Layers header
    const mapLayersHeaders = document.querySelectorAll('.card-header h5');
    for (let header of mapLayersHeaders) {
        if (header.textContent.includes('Map Layers')) {
            const badge = header.querySelector('.badge');
            if (badge) {
                badge.textContent = layerCount;
            }
            break;
        }
    }
    
    // Update any other layer count elements
    const countElements = document.querySelectorAll('.layer-count, [data-layer-count]');
    countElements.forEach(element => {
        element.textContent = layerCount;
    });
    
    // Show/hide "No layers" message
    const layersContainer = document.getElementById('layersList');
    const cardBody = layersContainer ? layersContainer.parentElement : null;
    
    if (layerCount === 0) {
        // Show "No layers" message if no layers exist
        if (cardBody) {
            const noLayersHtml = `
                <div class="text-center py-4">
                    <i class="fas fa-layer-group fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No layers added to this map yet.</p>
                    <button class="btn btn-outline-primary btn-sm" onclick="addNewLayer()">
                        <i class="fas fa-plus me-1"></i>Add Layer
                    </button>
                </div>
            `;
            cardBody.innerHTML = noLayersHtml;
        }
    } else {
        // Ensure layers list container exists
        if (cardBody && !document.getElementById('layersList')) {
            cardBody.innerHTML = '<div id="layersList"></div>';
        }
    }
    
    console.log(`Updated layer count to: ${layerCount}`);
}

function changeBasemap() {
    const selector = document.getElementById('basemapSelector');
    const selectedBasemap = selector.value;
    
    let newSource;
    switch(selectedBasemap) {
        case 'satellite':
            newSource = new ol.source.XYZ({
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                attributions: '© Esri, Maxar, Earthstar Geographics, and the GIS User Community'
            });
            break;
        case 'terrain':
            newSource = new ol.source.XYZ({
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}',
                attributions: '© Esri, USGS, NOAA'
            });
            break;
        default: // osm
            newSource = new ol.source.OSM();
    }
    
    basemapLayer.setSource(newSource);
}

// Toast notification function
function showToast(type, message) {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
        `;
        document.body.appendChild(toastContainer);
    }
    
    // Create toast element
    const toast = document.createElement('div');
    const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';
    toast.className = `alert ${bgClass} text-white alert-dismissible fade show mb-2`;
    toast.style.cssText = `
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    toast.innerHTML = `
        <strong>${type === 'success' ? '✅' : '❌'}</strong> ${message}
        <button type="button" class="btn-close btn-close-white" onclick="this.parentElement.remove()"></button>
    `;
    
    // Add to container
    toastContainer.appendChild(toast);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}

// Initialize map when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeMap();
});
</script>

<!-- OpenLayers JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
{% endblock %}
