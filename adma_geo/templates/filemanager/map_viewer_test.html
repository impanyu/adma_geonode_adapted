{% extends 'base.html' %}
{% load static %}

{% block title %}{{ file.name }} - Map Viewer - ADMA GEO{% endblock %}

{% block extra_head %}
<!-- OpenLayers CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">

<style>
    .map-container {
        height: 600px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
    }
    
    .ol-control {
        position: relative !important;
    }
    
    .ol-attribution {
        background: rgba(255,255,255,0.8) !important;
        border-radius: 4px !important;
        bottom: 8px !important;
        left: 8px !important;
        right: auto !important;
        max-width: calc(100% - 16px) !important;
        font-size: 11px !important;
        line-height: 1.2 !important;
        white-space: nowrap !important;
        padding: 2px 4px !important;
    }
    
    .ol-attribution ul {
        margin: 0 !important;
        padding: 0 !important;
        display: inline !important;
    }
    
    .ol-attribution li {
        display: inline !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .ol-attribution li:not(:last-child):after {
        content: ", ";
    }
    
    /* Attribution banner stretching full width at bottom of map */
    #map .ol-attribution {
        position: absolute !important;
        bottom: 0px !important;
        left: 0px !important;
        right: 0px !important;
        top: auto !important;
        width: 100% !important;
        transform: none !important;
        background: rgba(0, 0, 0, 0.8) !important;
        color: white !important;
        border-radius: 0 !important;
        padding: 8px 16px !important;
        font-size: 12px !important;
        max-width: none !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        box-shadow: 0 -2px 8px rgba(0,0,0,0.2) !important;
        z-index: 1000 !important;
        margin: 0 !important;
        text-align: center !important;
        border-top: 1px solid rgba(255,255,255,0.1) !important;
    }
    
    #map .ol-attribution ul {
        margin: 0 !important;
        padding: 0 !important;
    }
    
    #map .ol-attribution a {
        color: #87ceeb !important;
        text-decoration: none !important;
    }
    
    #map .ol-attribution a:hover {
        color: white !important;
        text-decoration: underline !important;
    }
    
    /* Zoom controls positioned at top-right - override OpenLayers defaults */
    #map .ol-zoom {
        position: absolute !important;
        top: 10px !important;
        right: 10px !important;
        left: auto !important;
        bottom: auto !important;
        background: rgba(255, 255, 255, 0.9) !important;
        border-radius: 6px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
        border: 1px solid rgba(0,0,0,0.1) !important;
        margin: 0 !important;
    }
    
    #map .ol-zoom button {
        background: transparent !important;
        border: none !important;
        color: #333 !important;
        font-size: 16px !important;
        font-weight: bold !important;
        width: 28px !important;
        height: 28px !important;
        margin: 2px !important;
        border-radius: 4px !important;
        transition: all 0.2s ease !important;
    }
    
    #map .ol-zoom button:hover {
        background: rgba(0,0,0,0.1) !important;
        color: #000 !important;
    }
    
    /* Scale line positioning - adjusted for full-width attribution banner */
    #map .ol-scale-line {
        position: absolute !important;
        bottom: 45px !important;
        left: 10px !important;
        right: auto !important;
        top: auto !important;
        background: rgba(255, 255, 255, 0.9) !important;
        border-radius: 4px !important;
        padding: 4px 8px !important;
        margin: 0 !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
        z-index: 1001 !important;
    }
    
    /* Full screen control */
    #map .ol-full-screen {
        position: absolute !important;
        top: 10px !important;
        right: 50px !important;
        left: auto !important;
        bottom: auto !important;
        background: rgba(255, 255, 255, 0.9) !important;
        border-radius: 6px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
        border: 1px solid rgba(0,0,0,0.1) !important;
        margin: 0 !important;
    }
    
    #map .ol-full-screen button {
        background: transparent !important;
        border: none !important;
        color: #333 !important;
        font-size: 14px !important;
        width: 28px !important;
        height: 28px !important;
        margin: 2px !important;
        border-radius: 4px !important;
        transition: all 0.2s ease !important;
    }
    
    #map .ol-full-screen button:hover {
        background: rgba(0,0,0,0.1) !important;
        color: #000 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Map Display -->
        <div class="col-lg-9">
            <h3>{{ file.name }} - Map Viewer</h3>
            
            <!-- Map Container -->
            <div class="map-container">
                <div id="map" style="width: 100%; height: 100%;"></div>
            </div>
        </div>
        
        <!-- Info Panel -->
        <div class="col-lg-3">
            <div class="card">
                <div class="card-header">
                    <h6>File Information</h6>
                </div>
                <div class="card-body">
                    <p><strong>Name:</strong> {{ file.name }}</p>
                    <p><strong>Size:</strong> {{ file.file_size|filesizeformat }}</p>
                    <p><strong>Type:</strong> {{ file.get_file_type_display }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
<script>
let map;

function initializeMap() {
    // Create WMS layer
    const wmsLayer = new ol.layer.Tile({
        source: new ol.source.TileWMS({
            url: '{{ geoserver_info.wms_url }}',
            params: {
                'LAYERS': '{{ geoserver_info.workspace }}:{{ geoserver_info.layer_name }}',
                'FORMAT': 'image/png',
                'TRANSPARENT': true
            },
            serverType: 'geoserver',
            crossOrigin: 'anonymous'
        }),
        title: '{{ file.name }}',
        opacity: 1.0,
        visible: true
    });

    // Create base layer
    const baseLayer = new ol.layer.Tile({
        source: new ol.source.OSM(),
        title: 'OpenStreetMap'
    });

    map = new ol.Map({
        target: 'map',
        layers: [baseLayer, wmsLayer],
        controls: [], // Start with no default controls
        view: new ol.View({
            center: ol.proj.fromLonLat([-99.5, 41.0]),
            zoom: 7,
            projection: 'EPSG:3857'
        })
    });
    
    // Add controls manually for full control
    map.addControl(new ol.control.Zoom());
    map.addControl(new ol.control.Attribution({
        collapsible: false,
        className: 'ol-attribution ol-unselectable ol-control ol-collapsed'
    }));
    map.addControl(new ol.control.ScaleLine());
    map.addControl(new ol.control.FullScreen());

    console.log('Map initialized successfully');
}

// Initialize map when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initializeMap, 200);
});
</script>
{% endblock %}
